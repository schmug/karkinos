---
name: issue-worker
description: Spawn a Claude worker to handle a GitHub issue. Fetches issue details, creates a feature branch, and works autonomously. Use when you want to delegate an issue to a worker.
allowed-tools: Bash, Read, Write, Edit, Glob, Grep
---

# Issue Worker Skill

Spawn a Claude worker to handle a GitHub issue.

## Usage

```
/issue-worker <issue-number>
```

## Examples

```
/issue-worker 42
/issue-worker 123
```

## Instructions

When the user invokes `/issue-worker`, follow these steps:

### 1. Fetch Issue Details

```bash
gh issue view <issue-number> --json number,title,body,labels,comments
```

### 2. Generate Branch Name

Create a descriptive branch name from the issue:
- Format: `feat/issue-<number>-<short-description>`
- Example: Issue #42 "Add retry logic" â†’ `feat/issue-42-add-retry-logic`

For bug issues, use `fix/` prefix instead of `feat/`.

### 3. Pre-Spawn Conflict Check

**CRITICAL**: Before creating the worktree, verify no file conflicts exist:

```bash
# Analyze which files the issue will likely modify based on its description
# Then check existing workers for conflicts
for worktree in $(git worktree list --porcelain | grep "^worktree" | cut -d' ' -f2 | grep -v "$(pwd)$"); do
  echo "=== Checking: $worktree ==="
  git -C "$worktree" diff --name-only staging 2>/dev/null
done
```

If any existing worker is modifying files that this issue will touch, **DO NOT SPAWN**. Either:
- Wait for the conflicting worker to complete
- Queue this issue for later
- Inform the user of the conflict

### 4. Ensure Staging Branch Exists

```bash
# Ensure staging branch exists and is up to date
git fetch origin
git checkout staging 2>/dev/null || git checkout -b staging origin/main
git pull origin staging 2>/dev/null || true
```

### 5. Create Worktree

```bash
BRANCH="feat/issue-<number>-<slug>"
WORKTREE_PATH="../artemis-issue-<number>"
# Create the worktree with a new branch FROM STAGING
git worktree add "$WORKTREE_PATH" -b "$BRANCH" staging
```

### 6. Build Task Prompt

Construct a comprehensive prompt for the worker:

```
You are working on GitHub Issue #<number>: <title>

## Issue Description
<body>

## Labels
<labels>

## Comments
<comments if any>

## Your Task
1. Understand the issue requirements
2. Implement the necessary changes
3. Write tests if applicable
4. Commit your changes with message referencing the issue (e.g., "feat: add retry logic (fixes #42)")
5. Push your branch and create a PR to staging

## Guidelines
- Follow existing code patterns in the repository
- Keep changes focused on the issue scope
- Add comments only where logic isn't self-evident
```

### 7. Spawn Worker

```bash
cd "$WORKTREE_PATH" && claude --print --dangerously-skip-permissions "$PROMPT"
```

### 8. Push and Create PR (targeting staging)

After the worker completes successfully and has made commits:

```bash
# Push the branch to origin
git push -u origin "$BRANCH"

# Create PR linking to the issue, targeting STAGING
gh pr create --base staging --title "<issue title>" --body "$(cat <<'EOF'
## Summary
<brief description of changes>

Closes #<issue-number>

## Changes
<list of key changes made>

---
ðŸ¤– Generated by Claude worker
EOF
)"

# Enable auto-merge (will merge automatically when CI passes)
gh pr merge --auto --squash
```

### 9. Report Results

After completion:
1. Show worker output summary
2. Show commits made: `git log $BRANCH --oneline -5`
3. Show files changed: `git diff staging...$BRANCH --stat`
4. Show the PR URL
5. Offer next steps:
   - Review the PR
   - Continue working on it
   - Clean up if failed

### 10. Track Worker

Add to `.claude/workers.json`:
```json
{
  "type": "issue",
  "issue": 42,
  "branch": "feat/issue-42-add-retry-logic",
  "base": "staging",
  "worktree": "../artemis-issue-42",
  "files": ["src/file1.py", "src/file2.py"],
  "created": "2024-01-15T10:30:00Z",
  "status": "completed",
  "pr": "<pr-url>"
}
```

## Important Notes

- **All branches are created from `staging`**, not main
- **All PRs target `staging`**, not main
- **ALWAYS check for file conflicts** before spawning a new worker
- Track which files each worker modifies to prevent conflicts

**Staging Workflow:** Worker PRs merge to staging. When CI is green on staging, create a PR from staging â†’ main.

**Tip:** Run `karkinos watch` in another terminal to monitor worker progress, or use `karkinos watch --spawn` to open it automatically.
